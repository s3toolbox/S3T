function dff=dff(signal,BC)
global PhotoBleachingTxt;
global NumbAvgSamples;
warning('dff')
% Calculates the delta fluoresence / base fluoresence signal.
%
% BC enables/disables bleach correction. Default = on;
if nargin <= 2
    BC = 1;
end

if BC == 1  %Do Bleach Correction?
    if 1
        
        switch PhotoBleachingTxt
            case 'iGluSnFr'
                ppp=[1,1.00018599460616,1.00027899190923,1.00046498651539,1.00055798381847,1.00074397842463,1.00083697572770,1.00102297033386,1.00111596763694,1.00130196224310,1.00139495954617,1.00158095415233,1.00167395145541,1.00185994606156,1.00195294336464,1.00213893797080,1.00223193527388,1.00241792988003,1.00251092718311,1.00269692178927,1.00278991909235,1.00297591369850,1.00306891100158,1.00325490560774,1.00334790291082,1.00344090021389,1.00362689482005,1.00371989212313,1.00390588672929,1.00399888403236,1.00418487863852,1.00427787594160,1.00446387054775,1.00455686785083,1.00464986515391,1.00483585976007,1.00492885706315,1.00511485166930,1.00520784897238,1.00539384357854,1.00548684088161,1.00557983818469,1.00576583279085,1.00585883009393,1.00604482470008,1.00613782200316,1.00632381660932,1.00641681391240,1.00650981121548,1.00669580582163,1.00678880312471,1.00697479773087,1.00706779503394,1.00716079233702,1.00734678694318,1.00743978424626,1.00762577885241,1.00771877615549,1.00781177345857,1.00799776806473,1.00809076536780,1.00818376267088,1.00836975727704,1.00846275458012,1.00864874918627,1.00874174648935,1.00883474379243,1.00902073839859,1.00911373570166,1.00920673300474,1.00939272761090,1.00948572491398,1.00957872221706,1.00976471682321,1.00985771412629,1.00995071142937,1.01013670603553,1.01022970333860,1.01041569794476,1.01050869524784,1.01060169255092,1.01078768715707,1.01088068446015,1.01097368176323,1.01106667906631,1.01125267367246,1.01134567097554,1.01143866827862,1.01162466288478,1.01171766018785,1.01181065749093,1.01199665209709,1.01208964940017,1.01218264670325,1.01236864130940,1.01246163861248,1.01255463591556,1.01264763321864,1.01283362782479,1.01292662512787,1.01301962243095,1.01320561703711,1.01329861434018,1.01339161164326,1.01348460894634,1.01367060355250,1.01376360085558,1.01385659815865,1.01404259276481,1.01413559006789,1.01422858737097,1.01432158467404,1.01450757928020,1.01460057658328,1.01469357388636,1.01478657118944,1.01497256579559,1.01506556309867,1.01515856040175,1.01525155770483,1.01543755231098,1.01553054961406,1.01562354691714,1.01571654422022,1.01580954152330,1.01599553612945,1.01608853343253,1.01618153073561,1.01627452803869,1.01646052264484,1.01655351994792,1.01664651725100,1.01673951455408,1.01683251185716,1.01701850646331,1.01711150376639,1.01720450106947,1.01729749837255,1.01739049567563,1.01757649028178,1.01766948758486,1.01776248488794,1.01785548219102,1.01794847949409,1.01813447410025,1.01822747140333,1.01832046870641,1.01841346600949,1.01850646331256,1.01859946061564,1.01878545522180,1.01887845252488,1.01897144982796,1.01906444713103,1.01915744443411,1.01925044173719,1.01943643634335,1.01952943364642,1.01962243094950,1.01971542825258,1.01980842555566,1.01990142285874,1.01999442016182,1.02008741746489,1.02027341207105,1.02036640937413,1.02045940667721,1.02055240398028,1.02064540128336,1.02073839858644,1.02083139588952,1.02092439319260,1.02111038779875,1.02120338510183,1.02129638240491,1.02138937970799,1.02148237701107,1.02157537431415,1.02166837161722,1.02176136892030,1.02185436622338,1.02194736352646,1.02213335813261,1.02222635543569,1.02231935273877,1.02241235004185,1.02250534734493,1.02259834464801,1.02269134195108,1.02278433925416,1.02287733655724,1.02297033386032,1.02306333116340,1.02315632846647,1.02324932576955,1.02334232307263,1.02343532037571,1.02362131498187,1.02371431228494,1.02380730958802,1.02390030689110,1.02399330419418,1.02408630149726,1.02417929880033,1.02427229610341,1.02436529340649,1.02445829070957,1.02455128801265,1.02464428531573,1.02473728261880,1.02483027992188,1.02492327722496,1.02501627452804,1.02510927183112,1.02520226913420,1.02529526643727,1.02538826374035,1.02548126104343,1.02557425834651,1.02566725564959,1.02576025295266,1.02585325025574,1.02594624755882,1.02603924486190,1.02613224216498,1.02622523946806,1.02631823677113,1.02641123407421,1.02650423137729,1.02659722868037,1.02669022598345,1.02678322328652,1.02687622058960,1.02696921789268,1.02706221519576,1.02706221519576,1.02715521249884,1.02724820980192,1.02734120710499,1.02743420440807,1.02752720171115,1.02762019901423,1.02771319631731,1.02780619362039,1.02789919092346,1.02799218822654,1.02808518552962,1.02817818283270,1.02827118013578,1.02827118013578,1.02836417743885,1.02845717474193,1.02855017204501,1.02864316934809,1.02873616665117,1.02882916395425,1.02892216125732,1.02901515856040,1.02910815586348,1.02910815586348,1.02920115316656,1.02929415046964,1.02938714777271,1.02948014507579,1.02957314237887,1.02966613968195,1.02975913698503,1.02985213428811,1.02985213428811,1.02994513159118,1.03003812889426,1.03013112619734,1.03022412350042,1.03031712080350,1.03041011810658,1.03041011810658,1.03050311540965,1.03059611271273,1.03068911001581,1.03078210731889,1.03087510462197,1.03087510462197,1.03096810192504,1.03106109922812,1.03115409653120,1.03124709383428,1.03124709383428,1.03134009113736,1.03143308844044,1.03152608574351,1.03161908304659,1.03171208034967,1.03171208034967,1.03180507765275,1.03189807495583,1.03199107225890,1.03208406956198,1.03208406956198,1.03217706686506,1.03227006416814,1.03236306147122,1.03236306147122,1.03245605877430,1.03254905607737,1.03264205338045,1.03264205338045,1.03273505068353,1.03282804798661,1.03292104528969,1.03301404259277,1.03301404259277,1.03310703989584,1.03320003719892,1.03329303450200,1.03329303450200,1.03338603180508,1.03347902910816,1.03347902910816,1.03357202641123,1.03366502371431,1.03375802101739,1.03375802101739,1.03385101832047,1.03394401562355,1.03403701292663,1.03403701292663,1.03413001022970,1.03422300753278,1.03422300753278,1.03431600483586,1.03440900213894,1.03440900213894,1.03450199944202,1.03459499674509,1.03468799404817,1.03468799404817,1.03478099135125,1.03487398865433,1.03487398865433,1.03496698595741,1.03505998326049,1.03505998326049,1.03515298056356,1.03524597786664,1.03524597786664,1.03533897516972,1.03543197247280,1.03543197247280,1.03552496977588,1.03561796707895,1.03561796707895,1.03571096438203,1.03571096438203,1.03580396168511,1.03589695898819,1.03589695898819,1.03598995629127,1.03608295359435,1.03608295359435,1.03617595089742,1.03617595089742,1.03626894820050,1.03636194550358,1.03636194550358,1.03645494280666,1.03654794010974,1.03654794010974,1.03664093741282,1.03664093741282,1.03673393471589,1.03682693201897,1.03682693201897,1.03691992932205,1.03691992932205,1.03701292662513,1.03701292662513,1.03710592392821,1.03719892123128,1.03719892123128,1.03729191853436,1.03729191853436,1.03738491583744,1.03738491583744,1.03747791314052,1.03757091044360,1.03757091044360,1.03766390774668,1.03766390774668,1.03775690504975,1.03775690504975,1.03784990235283,1.03784990235283,1.03794289965591,1.03794289965591,1.03803589695899,1.03803589695899,1.03812889426207,1.03812889426207,1.03822189156514,1.03822189156514,1.03831488886822,1.03831488886822,1.03840788617130,1.03840788617130,1.03850088347438,1.03850088347438,1.03859388077746,1.03859388077746,1.03868687808054,1.03868687808054,1.03877987538361,1.03877987538361,1.03887287268669,1.03887287268669,1.03896586998977,1.03896586998977,1.03905886729285,1.03905886729285,1.03915186459593,1.03915186459593,1.03924486189901,1.03924486189901,1.03924486189901,1.03933785920208,1.03933785920208,1.03943085650516,1.03943085650516,1.03952385380824,1.03952385380824,1.03952385380824,1.03961685111132,1.03961685111132,1.03970984841440,1.03970984841440,1.03980284571747,1.03980284571747,1.03980284571747,1.03989584302055,1.03989584302055,1.03998884032363,1.03998884032363,1.03998884032363,1.04008183762671,1.04008183762671,1.04017483492979,1.04017483492979,1.04017483492979,1.04026783223287,1.04026783223287,1.04026783223287,1.04036082953594,1.04036082953594,1.04045382683902,1.04045382683902,1.04045382683902,1.04054682414210,1.04054682414210,1.04054682414210,1.04063982144518,1.04063982144518,1.04063982144518,1.04073281874826,1.04073281874826,1.04073281874826,1.04082581605133,1.04082581605133,1.04082581605133,1.04091881335441,1.04091881335441,1.04091881335441,1.04101181065749,1.04101181065749,1.04101181065749,1.04110480796057,1.04110480796057,1.04110480796057,1.04110480796057,1.04119780526365,1.04119780526365,1.04119780526365,1.04129080256673,1.04129080256673,1.04129080256673,1.04129080256673,1.04138379986980,1.04138379986980,1.04138379986980,1.04138379986980,1.04147679717288,1.04147679717288,1.04147679717288,1.04156979447596,1.04156979447596,1.04156979447596,1.04156979447596,1.04156979447596,1.04166279177904,1.04166279177904,1.04166279177904,1.04166279177904,1.04175578908212,1.04175578908212,1.04175578908212,1.04175578908212,1.04184878638520,1.04184878638520,1.04184878638520,1.04184878638520,1.04184878638520,1.04194178368827,1.04194178368827,1.04194178368827,1.04194178368827,1.04194178368827,1.04203478099135,1.04203478099135,1.04203478099135,1.04203478099135,1.04203478099135,1.04203478099135,1.04212777829443,1.04212777829443,1.04212777829443,1.04212777829443,1.04212777829443,1.04212777829443,1.04222077559751,1.04222077559751,1.04222077559751,1.04222077559751,1.04222077559751,1.04222077559751,1.04222077559751,1.04231377290059,1.04231377290059,1.04231377290059,1.04231377290059,1.04231377290059,1.04231377290059,1.04231377290059,1.04231377290059,1.04240677020366,1.04240677020366,1.04240677020366,1.04240677020366,1.04240677020366,1.04240677020366,1.04240677020366,1.04240677020366,1.04240677020366,1.04240677020366,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04259276480982,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04249976750674,1.04240677020366,1.04240677020366,1.04240677020366,1.04240677020366,1.04240677020366,1.04240677020366,1.04240677020366,1.04240677020366,1.04240677020366,1.04240677020366,1.04240677020366,1.04231377290059,1.04231377290059,1.04231377290059,1.04231377290059,1.04231377290059,1.04231377290059,1.04231377290059,1.04231377290059,1.04222077559751,1.04222077559751,1.04222077559751,1.04222077559751,1.04222077559751,1.04222077559751,1.04212777829443,1.04212777829443,1.04212777829443,1.04212777829443,1.04212777829443,1.04212777829443,1.04212777829443,1.04203478099135,1.04203478099135,1.04203478099135,1.04203478099135,1.04203478099135,1.04194178368827,1.04194178368827,1.04194178368827,1.04194178368827,1.04194178368827,1.04184878638520,1.04184878638520,1.04184878638520,1.04184878638520,1.04184878638520,1.04175578908212,1.04175578908212,1.04175578908212,1.04175578908212,1.04166279177904,1.04166279177904,1.04166279177904,1.04166279177904,1.04166279177904,1.04156979447596,1.04156979447596,1.04156979447596,1.04156979447596,1.04147679717288,1.04147679717288,1.04147679717288,1.04147679717288,1.04138379986980,1.04138379986980,1.04138379986980,1.04129080256673,1.04129080256673,1.04129080256673,1.04129080256673,1.04119780526365,1.04119780526365,1.04119780526365,1.04110480796057,1.04110480796057,1.04110480796057,1.04110480796057,1.04101181065749,1.04101181065749,1.04101181065749,1.04091881335441,1.04091881335441,1.04091881335441,1.04082581605133,1.04082581605133,1.04082581605133,1.04073281874826,1.04073281874826,1.04073281874826,1.04063982144518,1.04063982144518,1.04063982144518,1.04054682414210,1.04054682414210,1.04054682414210,1.04045382683902,1.04045382683902,1.04045382683902,1.04036082953594,1.04036082953594,1.04036082953594,1.04026783223287,1.04026783223287,1.04017483492979,1.04017483492979,1.04017483492979,1.04008183762671,1.04008183762671,1.03998884032363,1.03998884032363,1.03998884032363,1.03989584302055,1.03989584302055,1.03989584302055,1.03980284571747,1.03980284571747,1.03970984841440,1.03970984841440,1.03961685111132,1.03961685111132,1.03961685111132,1.03952385380824,1.03952385380824,1.03943085650516,1.03943085650516,1.03933785920208,1.03933785920208,1.03933785920208,1.03924486189901,1.03924486189901,1.03915186459593,1.03915186459593,1.03905886729285,1.03905886729285,1.03896586998977,1.03896586998977,1.03887287268669,1.03887287268669,1.03877987538361,1.03877987538361,1.03877987538361,1.03868687808054,1.03868687808054,1.03859388077746,1.03859388077746,1.03850088347438,1.03850088347438,1.03840788617130,1.03840788617130,1.03831488886822,1.03831488886822,1.03822189156514,1.03822189156514,1.03812889426207,1.03812889426207,1.03803589695899,1.03794289965591,1.03794289965591,1.03784990235283,1.03784990235283,1.03775690504975,1.03775690504975,1.03766390774668,1.03766390774668,1.03757091044360,1.03757091044360,1.03747791314052,1.03747791314052,1.03738491583744,1.03729191853436,1.03729191853436,1.03719892123128,1.03719892123128,1.03710592392821,1.03710592392821,1.03701292662513,1.03691992932205,1.03691992932205,1.03682693201897,1.03682693201897,1.03673393471589,1.03673393471589,1.03664093741282,1.03654794010974,1.03654794010974,1.03645494280666,1.03645494280666,1.03636194550358,1.03626894820050];
                pbsignal=signal.*ppp;
                
                LM = size(pbsignal,2);
                mstart = mean(pbsignal(:,1:30),2);
                dff = (pbsignal-repmat(mstart,1,LM))./repmat(mstart,1,LM); % Delta f over v
            
            case 'loadPBProfile'
                % No bleach correction.
                LM = size(signal,2);
                mstart = mean(signal(:,1:30),2);
                dff = (signal-repmat(mstart,1,LM))./repmat(mstart,1,LM); % Delta f over v
            
            case 'global'
                % No bleach correction.
                LM = size(signal,2);
                mstart = mean(signal(:,1:30),2);
                dff = (signal-repmat(mstart,1,LM))./repmat(mstart,1,LM); % Delta f over v
            
            case 'none'
                % No bleach correction.
                LM = size(signal,2);
                mstart = mean(signal(:,1:30),2);
                dff = (signal-repmat(mstart,1,LM))./repmat(mstart,1,LM); % Delta f over v
                
            case 'linInt'
                [~,dff] = linBleachCorrect(signal);
            case 'minimum'
                %   [~,dff] = linMinBleachCorrect(signal);warning ('dff hack');
            case '2expInt'
                [~,dff] = exp2BleachCorrection(signal,NumbAvgSamples);warning ('dff hack');
            case 'auto2expInt'
                [~,dff] = findBaseFluorPoints(signal,'2exp');
            case 'autoLinInt'
                [~,dff] = findBaseFluorPoints(signal,'none');
            case 'autoPWLinFit'
                [~,dff] = findBaseFluorPoints(signal,'autoPWLinFit');
            otherwise
                error('Bleach correction Type not recognised.')
        end
        
        
    else
        filterExperiment();
    end
else
    % No bleach correction.
    mstart = mean(signal(:,1:30),2);
    %     dff = (signal-BC-repmat(mstart,1,LM))./repmat(mstart,1,LM); % Delta f
    dff = (signal-repmat(mstart,1,LM))./repmat(mstart,1,LM); % Delta f over v
    %     warning('Is -BC juist');
    
    if 0 % When using the minima
        LM = length(signal,2);
        mstart = min(signal(:,1:floor(LM/3)),[],2);
        dff = (signal-repmat(mstart,1,LM))./repmat(mstart,1,LM); % Delta f over f
    end
end

end
function filterExperiment()

%       bpFilt = designfilt('bandpassfir', 'FilterOrder', 60, ...
%   'CutoffFrequency1', 0.05, 'CutoffFrequency2', 15,...
%   'SampleRate', 33);

lpFilt = designfilt('lowpassfir', 'FilterOrder', 5, ...
    'StopbandFrequency', 1, ...
    'PassbandFrequency',.0125,...
    'SampleRate', 33);
%  BCsignal = filtfilt(bpFilt, signal');
% figure;plot(BCsignal);

%B= [-0.0010    0.0016   -0.0056    0.0103   -0.0221    0.0324   -0.0514    0.0625   -0.0812    0.0847  0.9057    0.0847   -0.0812    0.0625   -0.0514    0.0324   -0.0221    0.0103   -0.0056    0.0016   -0.0010]; % 0.05
B=[-0.0028   -0.0008   -0.0097    0.0036   -0.0323    0.0183   -0.0695    0.0407   -0.1059    0.0580    0.8783     0.0580   -0.1059    0.0407   -0.0695    0.0183   -0.0323    0.0036   -0.0097   -0.0008   -0.0028 ]; % 0.5
%B = [-0.0031   -0.0016   -0.0117   -0.0008   -0.0400    0.0060   -0.0867    0.0185   -0.1322    0.0287    0.8469    0.0287   -0.1322    0.0185   -0.0867    0.0060   -0.0400   -0.0008   -0.0117   -0.0016   -0.0031]; % Cut off 1Hz
%B= [-0.0014   -0.0000   -0.0101   -0.0000   -0.0417    0.0000   -0.0987    0.0000   -0.1568    0.0000    0.8175    0.0000   -0.1568    0.0000   -0.0987    0.0000   -0.0417   -0.0000   -0.0101   -0.0000   -0.0014]; % Cut off 1.5Hz
%B = [  0.0009    0.0030   -0.0057    0.0055   -0.0369    0.0015   -0.1038   -0.0133   -0.1790   -0.0280    0.7894   -0.0280   -0.1790   -0.0133   -0.1038    0.0015   -0.0369    0.0055   -0.0057    0.0030    0.0009];% Cut off 2Hz

B = [-0.000881204974448489,0.000577377032672532,-0.00128379607772674,0.000889591375312911,-0.00169411337486796,0.000938281567960555,-0.00170889978185108,0.000177045703057591,-0.000698949630417756,-0.00196422772818845,0.00173479495656630,-0.00553525829202193,0.00520338288883767,-0.00958236613084966,0.00820710648287145,-0.0120621263629164,0.00833357897203198,-0.0103423347856177,0.00303713739022988,-0.00220071054298347,-0.00924093812054890,0.0130511459127013,-0.0280781604442713,0.0338276269008911,-0.0506933519071779,0.0563240391268902,-0.0724628469541975,0.0754687010063404,-0.0882367327723690,0.0864848885307834,0.906639640344546,0.0864848885307834,-0.0882367327723690,0.0754687010063404,-0.0724628469541975,0.0563240391268902,-0.0506933519071779,0.0338276269008911,-0.0280781604442713,0.0130511459127013,-0.00924093812054890,-0.00220071054298347,0.00303713739022988,-0.0103423347856177,0.00833357897203198,-0.0120621263629164,0.00820710648287145,-0.00958236613084966,0.00520338288883767,-0.00553525829202193,0.00173479495656630,-0.00196422772818845,-0.000698949630417756,0.000177045703057591,-0.00170889978185108,0.000938281567960555,-0.00169411337486796,0.000889591375312911,-0.00128379607772674,0.000577377032672532,-0.000881204974448489];% 61order,
A = 1;

% BCsignal = filtfilt(B,A, signal');
% lowFreq= signal-BCsignal';

%lowFreq= filtfilt(B,A, signal');
lowFreq =filtfilt(lpFilt,signal);

[z,p,k] = butter(4,15/(33/2));              % lowpass filter - 5 Hz cutoff
SOS = zp2sos(z,p,k);                        % second order sections matrix
lowFreq = sosfilt(SOS,signal);


lowFreq  = sgolayfilt(signal,10,61   );
lowFreq  = medfilt1(signal,13,'truncate');
BCsignal = signal'-lowFreq';


fsgnal = fft(signal,[],2);
ct=4
fsgnal(:,1:ct)=0;
fsgnal(:,end-ct:end)=0;
BCsignal = ifft(fsgnal,[],2,'symmetric');

lowFreq= signal'-BCsignal';

baseF = mean(lowFreq,2);
dff = BCsignal'./baseF; % Using auto expansion here

% Debug
debug = 0;
n=1;
if debug
    %figure;
    subplot(4,4,4)
    cla
    plot(signal(n,:),'LineWidth',3)
    hold on
    plot(lowFreq(n,:)','r','LineWidth',2)
    subplot(4,4,12)
    
end
end
